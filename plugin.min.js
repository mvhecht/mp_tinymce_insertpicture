tinymce.PluginManager.add("mp_tinymce_insertpicture", function (editor, f) {
	var maxFileSize = 1048576;
	var maxImageWidth = 800;
	var maxImageHeight = 600;
	editor.addButton("mp_tinymce_insertpicture", {
		icon: 'image',
		title: 'Insert image',
		cmd: "mp_tinymce_insertpicture"
	});
	editor.addCommand("mp_tinymce_insertpicture", function () {
		if (window.File && window.FileReader && window.FileList && window.Blob) {
			var imgData;
			editor.windowManager.open({
				title: "Insert image",
				width: maxImageWidth,
				height: 700,
				html: 
					'<div><input type="file" class="input" name="mp_insertpicture_image" id="image_embed" style="font-size:14px;padding:30px;" accept="image/x-png, image/gif, image/jpeg"/></div>'
					+ '<div><canvas id="image_embed_canvas" width="' + maxImageWidth + '" height="' + maxImageHeight + '"></canvas></div>',
					buttons: [ 
					          {
					        	  text: "OK",
					        	  subtype: "primary",

					        	  onclick: function () {
					        		  if (imgData) {
					        			  editor.execCommand("mceInsertContent", false, "<img src='" + imgData + "' />");
					        		  } else {	  
					        			  alert("No file selected");
					        		  }
					        		  (this).parent().parent().close();
					        	  }
					          }, 
					          {
					        	  text: "Cancel",
					        	  onclick: function () {
					        		  (this).parent().parent().close();
					        	  }
					          }
					         ]
			});

			function fileSelectPreview(evt) {
				if (window.File && window.FileReader && window.FileList && window.Blob) {
					var imagefile = document.getElementsByName("mp_insertpicture_image")[0].files;                        
					if (imagefile.length > 0) {
						var filesiz = imagefile[0].size;
						if(filesiz > maxFileSize) {
							imgData = undefined;
							alert("The maximum file size is 1 MB.");
						}
						else {
							var class_filereader = new FileReader();

							class_filereader.onload = function (base64) {
								imgData = base64.target.result;
								var img = new Image();								
								img.onload = function() {
									console.log(img.width);
									console.log(img.height);

									var canvas = document.getElementById('image_embed_canvas');
									var canvasCtx = canvas.getContext('2d');
									var canvasW, canvasH;
									var proportion;
									if(img.width > maxImageWidth || img.height > maxImageHeight){
										alert("The maximum image size is " + maxImageWidth + " x " + maxImageHeight + " pixels. The image will be resized.");	

										var ratio = img.width / img.height;
										console.log(ratio);
										if (ratio >= 4/3) {
											canvasW = maxImageWidth;
											canvasH = maxImageWidth / ratio;
										} else {
											canvasW = maxImageHeight * ratio;
											canvasH = maxImageHeight;
										}
										proportion = canvasW / img.width;
										console.log(canvasW);
										console.log(canvasH);
										console.log(proportion);										
										console.log(imgData);
									} else {
										canvasW = img.width;
										canvasH = img.height;
										proportion = 1;
									}
									canvas.width = canvasW;
									canvas.height = canvasH;
									canvasCtx.scale(proportion, proportion);
									canvasCtx.drawImage(img, 0, 0);
									if (proportion != 1) imgData = canvas.toDataURL("image/png");
								};
								img.src = imgData;
							};
							class_filereader.onerror = function (err) {
								imgData = undefined;
								console.log("error", err);
								console.log(err.getMessage());
							};

							class_filereader.readAsDataURL(imagefile[0]);
						}
					} else {	  
						alert("No file selected.");
					}
				}
			}
			document.getElementById('image_embed').addEventListener('change', fileSelectPreview, false);
		}
		else {
			alert("Update your browser to one that supports HTML5.");
		}
	});

	editor.addMenuItem("mp_tinymce_insertpicture", {
		cmd: "mp_tinymce_insertpicture",
		context: "insert",
		text: 'Insert image',
		icon: 'image',
	});
});